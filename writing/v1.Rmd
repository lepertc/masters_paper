---
title: "Effects of rest and tiredness on soccer and tennis match outcomes"
author: "ChloÃ© Lepert"
date: "11/6/2018"
output: 
  pdf_document:
    toc: true
    number_sections: true
abstract: "Many factors influence athletic performance in competitions. Most models predicting results focus on the strength of the team and the location of the competition, but other factors that players and teams can control could have an impact. In this presentation, we look at how rest and tiredness impact the performance of soccer teams and tennis players. We find no effect for the number of days since a previous match on soccer outcomes, but find that the length of a tennis match may negatively impact a player in his following match."
fontsize: 12pt
header-includes:
- \usepackage{float}
---

```{r include=FALSE}
knitr::opts_chunk$set(echo = FALSE, cache = TRUE, warning = FALSE, message = FALSE)
library(ggplot2); theme_set(theme_bw())
library(stargazer)
```

# Introduction

Many factors influence athletic performance in competitions. Most models predicting results focus on the strength of the team and the location of the competition, but other factors that players and teams can control could have an impact. In this paper, we look at how rest and tiredness impact the performance of soccer teams and tennis players. We find no effect for the number of days since a previous match on soccer outcomes, but find that the length of a tennis match may negatively impact a player in his following match.

## Question 

We aim to quantify the effect of rest on soccer match outcomes. We ask two questions looking at short and long-term rest levels of a team:

\begin{enumerate}
    \item How does the number of days since a previous match impact the performance of a team?
    \item How does the game load of a team in the past month, two months, and three months impact the performance of a team?
\end{enumerate}

For tennis, we look at the effect of the previous match attributes on match outcomes. We ask the following questions:

\begin{enumerate}
  \item How does the length of the previous match impact performance?
  \item How does this effect vary by game attributes such as number of possible set and surface?
\end{enumerate}

We will look at different models in which performance will be the probability of winning, drawing, and losing or the expected number of goals scored.

## Football and Tennis

Before explaining our motivation, we will first give an overview of the two sports so that the reader may better understand our motivation. 

### English Football

English soccer is comprised of multiple competitions. 

\begin{itemize}
    \item The top 20 teams in England play in the \textbf{Premier League}. They play each other twice per season: once at home and once away resulting in 380 games played. Each match earns teams points; a win gets a team 3 points, a draw 1 point, and loss 0 point. The team with the most points win. The bottom two teams are relegated to the EFL Championship. The top two teams from EFL Championship advance to the Premier League. The third to last team in the Premier League and the third team in the EFL Championship playoff to play in the Premier League. (Wikipedia Contributors)
    \item The \textbf{FA cup} is a knockout tournament open to teams in 10 levels of English football. Teams enter the tournament at different stages depending on the level they play in. Teams that play in the Premier league enter the 3rd round in January with the hope of making it to the final played in May. (Wikipedia Contributors)
    \item The \textbf{EFL cup} is a tournament similar to the FA cup but open only to levels 1 through 4. Premier League teams enter in August. Matches continue until the final in February. Teams playing in European competitions do not play in this cup (Wikipedia Contributors)
\end{itemize}

There are two European competitions played with teams from different European leagues:

\begin{itemize}
    \item The top teams play in the \textbf{Champions League}. It starts with a group stage of 32 teams in which mini round robins are run in each group to determine which 16 teams go on to the tournament. Teams not advancing to the tournament are transferred to the Europa league. In the tournament stage, teams meet twice: once home and once away. Since only one team can move forward to the next round, the return leg can go overtime to decide who win. The final is played in one match in a location determined ahead of time. In England the top three premier league teams automatically qualify for the Champions League. The fourth-place team qualifies for a playoff round. (Wikipedia Contributors)
    \item The \textbf{Europa league} is similar to the Champions league in format but played with the top teams not qualifying for the champions league. Depending on how a team qualifies it enters the competition at different rounds.  The 5th place Premier league team qualifies for the group stage, with the winners of the FA cup and EFL cup qualifying for earlier rounds. (Wikipedia Contributors)
\end{itemize}

Depending on the year, the schedule is inter-spaced with 2-week \textbf{international breaks}, in which players are called to represent their national team in international friendlies or qualifying matches for continent or world cups. 

The wide variety of competition that a team can play in means that teams have different schedule loads as shown in the following figure.

```{r, fig.height = 3, fig.width = 5, fig.align='center'}
source("~/Documents/masters_paper/Figures/Make/gameLoad.R")
p
```

### Men's professional tennis

Throughout the season, players play in a variety of tournaments. Performance in tournaments determines the number of points earned towards the players' world rankings. Tournaments have different importances influencing how many points they grant players. 

A player's ranking determines a player's seeding in individual tournaments. Officials design seedings to have top players face each other as late in the tournament as possible.

Professional tennis is played in matches of 3 or 5 sets. The four Grand Slam tournaments: Australian Open, Rolland Garros, Wimbledon, and US open are played in 5 sets, while the rest of tournaments are played in 3 sets. The first player to win 2 or 3 sets wins the match and moves on to the next round.

The winning mechanism allows for games of different time length; the distribution of which is shown below. 

```{r, fig.height = 3, fig.width = 5, fig.align='center'}
source("~/Documents/masters_paper/Figures/Make/tennisData.R")
p1
```

A set is won by winning at least six games and having a two-game lead resulting in sets of different intensities; a set could be won 6-1, or 10-8. The distribution of the number of games is shown below along.

```{r, fig.height = 3, fig.width = 5, fig.align='center'}
p2
```

## Relevance

Football game scheduling varies from league to league. In particular, some leagues take a winter break while others do not. Some speculate that this winter break influences performance in inter-league competitions such as the Champions and Europa league by allowing teams that have the break to be more refreshed. (Glendenning)

Further Champions and Europa league games are played Tuesday through Thursday, while club games are played Friday through Mondays, leading to a variety of rest days going into Champions and Europa league games. (Critchley) Some leagues are more willing to accommodate teams playing in European competitions than others by letting them schedule their games earlier in the weekend.

In tennis, seedings are designed so that players' paths to the finals are as fair as possible. The tournament is set up at the beginning of the tournament such that assuming the highest ranked player always wins, in each round, the highest ranked player always plays the lowest ranked player. Sometimes a low ranked player will upset high ranked player which can cause an easier path for future players. (Cooper)

Here we look at whether the length of the previous match on a player's path impacts performance on the current game. While some of the influence of a match's length are outside a player's control, for example how hard their oponent is to beat, other attributes might not be.
An effect of previous matches on present matches could affect how matches are played. If players know that long matches hurt them in the long run, they might work harder to win quickly. Of course, we also need to measure the long run effect of working harder before making such a suggestion.

## Approach

While we would ideally want to look at how rest affects performance in European competitions, doing so is difficult because the teams that play each other in European competitions do not do so frequently enough for us to calculate and control for team ability on an even scale. We will instead model the outcome of Premier League matches, which are set up such that we can easily control for team ability. We will evaluate how matches in competitions other than the premier league influence premier league matches.

This approach assumes that European competition games are similar to Premier League games. This is mostly true except for the fact that European competition games can result in overtime and are higher stakes; a loss results in elimination. We assume that if we see rest impact outcomes in premier league games, rest is likely to have an impact in European games. 

For tennis, we measure the effects of previous match attributes on the next match. We look at how these effects differ by surface and whether the match is best of 3 or best of 5.

## Literature review

### Rest time

Most of the research on impacts of game scheduling focuses on injury and measures of certain activities in games such as distance ran and the number of sprints, but not on overall game outcomes. 

Over the past decades, Carlos Lago Penas conducted a series of studies looking at how physical behaviors of players, such as distance run at certain speeds, evolve over a series of consecutive games with small rest periods and found minor to no differences in physical behaviors across games. 

In 2010, Dupont et al. found a higher injury rate for football players who played two matches a week compared to players playing one match a week.

### Modeling football match outcomes

The sports statistic community quickly converged on the best way to model soccer scores. In 1982, M. J. Maher introduced two independent Poisson distributions as a way to model soccer scores. He proposed using a team's attacking strength and its opponent's defensive weakness as predictors of the number of goals scored. Maher also found that using a Bivariate Poisson distribution with a correlation of 0.2 improved his model's fit. 

Expanding on Maher's work, Karlis and Ntzoufras proposed a diagonal inflated bivariate Poisson model in which the probabilities of draws are increased in 2003.  They also created an R package to fit bivariate Poisson GLMs which we will utilize.

We will also look at the proportional odds ordered logistic model which predicts the probability of a win, tie, or loss.

### Tennis match length

In 2007, Pereir, Nakamura, and de Jesus tracked physical performance -distance covered in a set and stroke proficiency in the first two sets of a match and found no decrease in physical performance. 

In 2015, Goosens, Kemperas, and Kosing looked at how the difference in number of sets in the previous match impacts outcome in the current match in Grand Slams. They found a significant decrease in probability of winning for a difference in sets number of 1 for women and 2 for men.

### Predicting tennis matches

Most models aimed at tennis betting use the hierarchical structure of tennis matches set-game-point to build stochastic models. In 2015, Sipky proposed using historical data about the players and a neural network and achieved a 75% performance improvement over existing models. In 2003, Klassen and Magnus proposed a logistic model to forcast tennis matches. We chose this model in our analysis as it easily lends itself to inference.

## Data

### Tennis

#### Data set

The data was obtained from Kaggle and contains outcomes and attributes of ATP (Association of Tennis Professionals) Men's tennis matches between 2000 and 2017. Each of our observations represents a game and contains information about one of the players and his opponent. The player is selected at random such that the player wins 50% of matches.

#### Response variable

The response variable is whether or not a player won a game. As players have to either win or lose, the response variable is distributed 50-50 win-lose.

#### Predictors

The predictor is the length of the previous match played by the player in hours. Three-quarters of the games are less than 2 hours long, but games can go on for many more hours. About five percent of games go on for more than 3 hours.

```{r, cache = FALSE}
source("~/Documents/masters_paper/Figures/Make/tennisData.R")
```

#### Control variables

We control for player ability by looking at the player's rank at the beginning of the tournament as well as the number of points earned in order to achieve the ranking. Both controls are important in predicting winners. They differ slightly in that the player ranked number 1 could be leading by a few points or hundreds of points. The broader scale of ranking points provides a better proxy for underlying player ability.

We also control for whether or not a player is seeded. Seeded players tend to be the top 32 players in the tournament and do not have to play as many early rounds.

We also look at whether or not the effects differ by surface or by the number of sets needed to win.

##### Surface

Tennis is either played on Carpet, Clay, Grass, or Hard. Players will have preferences for different surfaces, and some surfaces are often cited as causes for injuries (cite). The distribution of surfaces is shown below.

```{r results = "asis"}
stargazer(s, summary = FALSE, no.space = TRUE, header = FALSE, 
          table.placement = "H", type = "latex", 
          title = "Distribution of matches by surface")
```


##### Sets needed to win

Most men's tennis matches are won by a player winning two sets. The four major tournaments: Rolland Garros, Wimbledon, US Open, and Australian open require three sets to be won in order to win.

#### Games looked at

We look at all matches for which both players played their previous match in the same tournament. This allows us to make sure that the previous match happened within a reasonable number of days and that surface and best of quantity are the same between player histories. We remove any match including unranked player.

### Soccer

#### Data set

The R package "engsoccerdata" provides us with scores from matches in England as well as European competition matches. We limit ourselves to matches occurring in seasons 1995 through 2015. The design of English Football stays consistent throughout this time range, and the data set is complete for these years.

#### Response variable

We use two different response variables: 1. the number of home and away goals and 2. whether the team won, tied, or lost. The distribution of home and away goals is shown below.

```{r include=FALSE}
source("~/Documents/masters_paper/Figures/Make/goalDist.R")
```

```{r, fig.height = 4, fig.width = 5, fig.align='center'}
plot(p)
```


Most models for the number of goals by a team in a game assume the number of home and away goals follow a Poisson distribution. We see that this approximately true. There tend to be more games than expected with zero goals and the variance is slightly larger than the mean number of goals.

A game is a home win if the number of home goals exceeds the number of visitor goals, tied if both teams score the same number of goals, and a visitor win if the number of visitor goals exceeds the number of home goals. The distribution of outcomes is shown below. 

\begin{table}[H] \centering 
  \caption{Distribution of game outcomes} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}} cccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
Outcome & Number of games & Share of games \\ 
\hline \\[-1.8ex] 
Home win & $1,966$ & $0.458$ \\ 
Tie & $1,143$ & $0.266$ \\ 
Visitor win & $1,187$ & $0.276$ \\ 
\hline \\[-1.8ex] 
\end{tabular} 
\end{table} 

#### Predictors

Using this dataset, we calculate the number of days since the previous game. Before performing our analysis on the effect of rest time, we remove games in which either of the team's previous game was over eight days ago. If the team's last non-international game was more than eight days prior, it is possible that an international break occurred which we have no way of controlling for. 

The distribution of rest time for the home and away team is shown below. 

\begin{table}[H] \centering 
  \caption{Distribution of rest time (in days) for home and away teams} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}} ccccccccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 &  &  &  &  & Visitor &  &  &  \\ 
 &  & 2 & 3 & 4 & 5 & 6 & 7 & 8 \\ 
\hline \\[-1.8ex] 
 & 2 & $128$ & $9$ & $1$ & $0$ & $3$ & $0$ & $1$ \\ 
 & 3 & $12$ & $343$ & $155$ & $22$ & $38$ & $121$ & $7$ \\ 
 & 4 & $0$ & $165$ & $238$ & $43$ & $38$ & $91$ & $61$ \\ 
Home & 5 & $1$ & $26$ & $50$ & $63$ & $31$ & $90$ & $31$ \\ 
 & 6 & $3$ & $22$ & $34$ & $42$ & $110$ & $278$ & $41$ \\ 
 & 7 & $0$ & $118$ & $74$ & $93$ & $302$ & $798$ & $110$ \\ 
 & 8 & $1$ & $3$ & $47$ & $42$ & $32$ & $106$ & $272$ \\ 
\hline \\[-1.8ex] 
\end{tabular} 
\end{table} 

We also create a binary variable for whether or not a team is "more" (6-8 days) or "less" (1-5 days) rested and found the following distribution of rest. 

\begin{table}[!htbp] \centering 
  \caption{Distribution of rest time for home and away teams} 
  \label{} 
\begin{tabular}{@{\extracolsep{5pt}} cccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 &  & Away &  \\ 
 &  & 1-5 days & 6-8 days \\ 
\hline \\[-1.8ex] 
Away & 1-5 days & $1,256$ & $512$ \\ 
 & 6-8 days & $479$ & $2,049$ \\ 
\hline \\[-1.8ex] 
\end{tabular} 
\end{table} 

#### Control variables

Using Premier Leauge games, we calculate each team's attacking and defensive weakness. (Cronin) The attacking strength is the ratio of the average number of goals scored by a team in a season to the average number of goals scored in the league that season. The defensive weakness is the ratio of the average number of goal conceded by a team in a season to the average number of goals conceded in the league that season. 
It is generally believed that the performance of a team differs depending on whether the team is home or visiting; therefore we calculate Attacking Strength and Defensive Weakness for home and away games. The better a team, the higher its attacking strength and the lower its defensive weakness strength will be. We will use the previous years attacking and defensive weakness to control for a team's ability. We exclude recently promoted teams from our analysis as we cannot use their previous season to calculate such strengths, since they played against a different set of teams. The distribution of attacking and defensive strengths is shown below.

```{r, fig.height = 4, fig.width = 6, fig.align='center'}
source("~/Documents/masters_paper/Figures/Make/strengthDist.R")
p
```

We also control for the number of games a team plays each season. Better teams will last longer in playoff competitions such as the FA Cup, Europa League, and Champions League, that happen concurrently with premier league games. These teams will play more games per season and thus on average have lower rest times.

#### Matches looked at

As described in the previous subsections there are two points at which we remove premier league games from our data set.
\begin{enumerate}
  \item{Matches with recently promoted teams. Since we use the previous premier league season to calculate the team's attacking strength and defensive weakness we cannot calculate these quantities for recently promote teams. Removing these matches removes 2540 out of 7980 matches (32\%).}
  \item{Matches with over eight days of rest. It is likely that an international match happened during the break which we do not have in our data. Leaving these matches in would lead to low rest matches presenting themselves as high rest matches. Removing these matches removes 1144 out of the remaining 5440 matches (21\%), leaving 4296 matches for analysis.}
\end{enumerate}

# Methods

There are many ways to model the outcomes of sporting events. We first look at ways to model actual scores such as the Poisson model, the linear model for goal difference, and the bivariate poisson model for soccer scores. We also look at ways to model the outcomes Win-Tie-Lose for soccer and Win-Lose for tennis with a proportional odds cumulative model and logistic model

## Poisson model

The Poisson model is most commonly used to model soccer scores. It assumes that the number of goals scored by a team in a soccer game follows a Poisson distribution of some parameter. We will use a GLM with a Poisson link to predict the parameter. In the traditional Poisson model for the number of goals scored by a team, the team's attacking strength and its opponent's defensive weakness are the covariates used to model the parameter. Here we add measures of rest as predictors to see if they are predictive of goals scored.

### Model

\begin{itemize}
    \item Let $j={h, a}$ be an indicator for whether we are modeling home or away games.
    \item Let $G_{j,i}$ be the number of home or away goals in game $i$.
    \item Let $x_i$ be the predictors for game i.
    \item Assume that $G_j \thicksim Poisson(\lambda_j)$. $P_P(G_{j,i}=g_{j,i})=\frac{\lambda_j^{g_{j,i}} e^{\lambda_{j,i}}}{g_{j,i} !}$
    \item The parameter $\lambda_j$ is a linear combination of the predictors $X_j$: $\lambda_j = X_j \beta_j$  
\end{itemize}

### Verifying the Poisson assumption under the null

We use a Chi Squared test to verify that goals are poisson distributed. The Chi Squared test allows us to determine if the difference between two distribution is significant. We calculate the expected frequency of each number of goals under the poisson assumption and compare it to the actual number of goals. We use the difference between the two to calculate a sum which we expect to be Chi Squared distributed.

$\sum_{i=1}^k{\frac{(f_i-e_i)^2}{e_i}} \sim \chi_k^2$

Where
\begin{itemize}
    \item $k$ is the maximum number of goals; 9 for home teams and 6 for visitor teams.
    \item $f_i$ is the observed frequency
    \item $e_i$ is the expected frequency
\end{itemize}

We find that sum is not distributed Chi Squared with a p-value of 0.0072 for home goals and 0.0039 for visitor goals. The distributions are slightly overdispered as can be seen in figure 4 where we have more games with zero and more than 4 goals than expected. Calculating the overdispersion we find home goals to be overdispered by 1.13 and visitor goals by 1.11. Because the overdispersion is so close to 1, we will not use a quasipoisson model which takes overdispersion into account and stick to the poisson model.

## Linear model for goal difference

The square root of a Poisson distribution can be approximated by a normal distribution (cite). We can, therefore, approximate the difference in square root goals as the difference of two normal distributions, which is itself a normal distribution. This allows us to fit a normal model to the transformed goal difference. The figure below shows the distribution of square root goal difference and its approximation as a normal distribution.

```{r, fig.height = 3, fig.width = 5, fig.align='center'}
#http://tina.wiau.man.ac.uk/docs/memos/2001-010.pdf
source("~/Documents/masters_paper/models/lmGoalDiff.R")
p
```

We see that the difference is approximately normal with more ties than expected.

Our model aims to find a linear combination of our predictors that best approximates the square root goal difference.

$\sqrt{G_{h,i}} - \sqrt{G_{v,i}} = X_j \beta_j$

In this model, we could use the difference in the number of rest days as a predictor instead of the number of rest days for the home team and number of rest days for the away team. Using the difference in rest as a predictor is equivalent to using the rest days for the home team and the away teams and forcing their coefficients in the model to be the opposite. 

$\beta_1 X_{home-rest} + \beta_2 X_{visitor-rest}$ vs. $\beta_1(X_{home-rest} - X_{visitor-rest})$

We chose not to add this constraint and allow home and away rest to vary freely.

## Bivariate poisson model

The bi-variate Poisson model assumes that the number of goals that home and away teams score is not only determined by factors that affect each team, but also by factors affecting the game itself.

\begin{itemize}
    \item Assume that $G_j \thicksim Poisson(\lambda_j + \lambda_g)$. 
    \item The parameter $\lambda_g$ is a linear combination of the predictors $X$: $\lambda_g = X_g \beta_j$  
\end{itemize}

The probability distributions for the number of goals by the home and away team is given by:

\begin{equation*}
    P_{BP}(G_h = g_h, G_a = g_a|\lambda_h, \lambda_a,  \lambda_g) = 
    e^{-(\lambda_h + \lambda_a + \lambda_g)} 
    \frac{\lambda_h^{g_h}}{g_h!} 
    \frac{\lambda_a^{g_a}}{g_a!} 
    \sum_{i=0}^{min(g_h, g_a)} 
    {g_h \choose i} 
    {g_a \choose i} 
    i! 
    \bigg( \frac{\lambda_g}{ \lambda_g \lambda_a} \bigg)
\end{equation*}

## Proportional odds cummulative logit model

We have three possible outcomes: a home win, tie, or visitor win. Each outcome has a probability $\pi_i$ of happening. The probabilities of the three outcomes sum to 1 as no other outcome is possible.
$\pi_h +\pi_t +\pi_v = 1$

The probability that home loses is $1-\pi_h-\pi_t=\pi_v$ and its log odds are $L_v=\log{ \big( \frac{\pi_v}{\pi_h+\pi_t} \big)}$

The probability that home loses or ties is $1-\pi_h=\pi_v + \pi_t$ and its log odds are $L_t=\log{ \big( \frac{\pi_v + \pi_t}{\pi_h} \big)}$

The log odds of these two events are assumed to be a linear combination of the predictors; $L_v = \alpha_v + X\beta_v$ and $L_t = \alpha_t + X\beta_t$. 

In the proportional odds model we require the coefficients $\beta_v$ and $\beta_t$ to be the same; $L_v = \alpha_v + X\beta$ and $L_t = \alpha_t + X\beta$.

The underlying assumption is that there is an unobserved variable which determines match outcomes. Here this variable is the ability of a home team to win against a given opponent. The predictors X change our belief as to how this ability is distributed. 

```{r, fig.height = 3, fig.width = 5, fig.align='center'}
source("~/Documents/masters_paper/Figures/Make/orderedEx.R")
p
```

$\alpha_v$ can be thought of as the threshold in ability to go from a tie or home win to a visitor win and $\alpha_t$ as the threshold to go from a home win to a tie or visitor win or tie. Depending on the distribution of underlying ability, the probability of each outcome changes. In the figure above if the feature is matched, the probability of a win is 78\% but if the feature is not matched the probability of a win is 42\%.

The two outcome case of this model is known as logistic regression. We will use it to model the outcome of tennis matches.

## Logistic regression

Logistic regression allows us to model binary outcomes where one outcome, here a win, happens with probability p and the other, here a loss, happens with probability 1-p. Logistic regression assumes that the log odds of the probability of the event are given by a linear combination of the predictors. The model can be written as $\log{\big(\frac{p}{1-p}\big)}=X\beta$ where the first column of X is filled with ones for the intercept, and the other columns are the predictors. 

# Results

## Soccer

### Simple Poisson GLM

Table 5 summarizes the GLM models for the number of home and away goals. Rest comes in the model either as the number of days since the previous game (1) and (3) or as whether or not the team had more than 5 days of rest (2) and (4). In neither of the four models do we see rest as affecting the number of goals scored

The strongest effects come from the attacking strength of the home team and defensive weakness of the visitor team. This not too surprising as most models looking to predict soccer outcomes use the product of these two quantities as the expected number of goals. A team with a high attacking strength should score more since it has scored more in the past, and a team with a high defensive weakness should take in more goals as it has in the past.

We also see an effect from the game load of a team. Game load also measure the quality of a team. Better teams will qualify for more games and thus have a higher game load. We expect to see an increase in a team's game load increase its predicted number of goals and an increase in its opponent's game load decrease a team's predicted number of goal; which is what we see.

```{r results = "asis"}
source("~/Documents/masters_paper/models/simpleGlm.R")
stargazer(m_home_days, m_home_bin, m_vis_days, m_vis_bin, single.row = TRUE,
          title = "Generalized Linear Models with Poisson link", header = FALSE,
          dep.var.labels = c("Home goals", "Visitor goals"),
          covariate.labels = c("Team rest (days)", "Opponent rest (days)",
                               "Team rest > 5 days", "Opponent rest > 5 days",
                               "Team attacking strength", 
                               "Opp. defensive weakness",
                               "Team load", "Opponent load",
                               "Constant"),
          table.placement = "H", font.size = "footnotesize")
```


### Linear model for goal difference

Table 6 summarizes the model for the square root goal difference. We find that the rest of the home and away team have no significant impact on the goal difference. Predictors highlighting the strength of the teams involved are most important.

```{r results = "asis"}
source("~/Documents/masters_paper/models/lmGoalDiff.R")
stargazer(lm_diff, single.row = TRUE, header = FALSE,
          title = "Linear model for the difference in goals scored", 
          dep.var.labels = "Goal difference", font.size = "footnotesize",
          covariate.labels = c("Team rest (days)", "Opponent rest (days)",
                               "Team attacking strength", 
                               "Team defensive weakness",
                               "Opp. attacking strength",
                               "Opp. defensive weakness",
                               "Team load", "Opponent load",
                               "Constant"),
          table.placement = "H")
```


### Proportional odds cummulative logit model

As seen in the table below, the odds of moving from a visitor win to a tie or a tie to a home win increase when the home team's attacking strength, home team's game load, or visitor's team defensive weakness increases. The opposite happens when the teams are reversed. The directionality of these findings agrees with the other models. The proportional odds cumulative logit model does not find any effect of rest, whether measured in days or as a binary variable. 

```{r results = "asis"}
source("~/Documents/masters_paper/models/orderedLogistic.R")
stargazer(m_days, m_bin, single.row = TRUE, font.size = "footnotesize",
          dep.var.labels = "Probability of winning",
          title = "Ordered logistic model", header = FALSE,
          covariate.labels = c("Team rest (days)", "Opponent rest (days)",
                               "Team rest > 5 days", "Opponent rest > 5 days",
                               "Team attacking strength", 
                               "Opp. defensive weakness",
                               "Opp. attacking strength",
                               "Team defensive weakness",
                               "Team load", "Opponent load",
                               "Constant"),
          table.placement = "H")
```

### Bivariate Poisson

The bivariate poisson model also finds game load,  attacking strength, and defensive weakness to be significant predictors. It also finds a team's rest to have a small but significant effect on number of goals scored by a team along with a small negative but significant effect on number of goals scored by a team's opponent. 

The model also finds rest of the home team to have a negative effect on the number of goals scored in the game and rest of the visitor team to have a positive effect on number of goals scored in the game.

\begin{table}[H] \centering 
  \caption{Bivariate model for number of goals scored by each team} 
  \label{} 
\footnotesize 
\begin{tabular}{@{\extracolsep{5pt}} cccc} 
\\[-1.8ex]\hline 
\hline \\[-1.8ex] 
 &  & (1) & (2) \\ 
\hline \\[-1.8ex] 
Home & Intercept & -0.254\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.017) & -0.252\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.018) \\ 
 & Visitor defensive weakness & 0.427\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.005) & 0.418\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.005) \\ 
 & Visitor load & -0.021\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0) & -0.019\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0) \\ 
 & Visitor rest (days) &  & -0.004\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.001) \\ 
 & Visitor rest \textgreater  5 days & -0.081\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.003) &  \\ 
 & Home attacking strength & 0.451\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.004) & 0.45\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.004) \\ 
 & Home load & 0.014\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0) & 0.013\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0) \\ 
 & Home rest (days) &  & 0.001 (0.001) \\ 
 & Home rest \textgreater  5 days & 0.06\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.002) &  \\ 
\hline \\[-1.8ex] 
Visitor & Intercept & 0.1\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.02) & 0.046\textasteriskcentered \textasteriskcentered  (0.022) \\ 
 & Visitor Attacking strength & 0.5\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.004) & 0.506\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.004) \\ 
 & Visitor load & 0.008\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0) & 0.008\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0) \\ 
 & Visitor rest (days) &  & -0.01\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.001) \\ 
 & Visitor rest \textgreater  5 days & -0.075\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.003) &  \\ 
 & Home defensive weakness & 0.275\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.005) & 0.278\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.005) \\ 
 & Home load & -0.028\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0) & -0.028\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0) \\ 
 & Home rest (days) &  & 0.01\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.001) \\ 
 & Home rest \textgreater  5 days & 0.055\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.003) &  \\ 
\hline \\[-1.8ex] 
Game & Intercept & 0.156 (0.179) & 0.872\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.164) \\ 
 & Visitor attacking strength & -0.891\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.054) & -0.891\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.059) \\ 
 & Visitor defensive strength & -2.785\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.073) & -2.641\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.083) \\ 
 & Visitor load & -0.008\textasteriskcentered \textasteriskcentered  (0.003) & -0.012\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.004) \\ 
 & Visitor rest &  & 0.054\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.011) \\ 
 & Visitor rest \textgreater  5 days & 0.456\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.086) &  \\ 
 & Home attacking strength & -1.241\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.08) & -1.289\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.077) \\ 
 & Home defensive weakness & -0.478\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.054) & -0.505\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.058) \\ 
 & Home load & 0.057\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.003) & 0.051\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.003) \\ 
 & Home rest (days) &  & -0.07\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.01) \\ 
 & Home rest \textgreater  5 days & -0.129\textasteriskcentered \textasteriskcentered \textasteriskcentered  (0.035) &  \\ 
\hline \\[-1.8ex] 
\end{tabular} 
\end{table} 

## Tennis - Logistic GLM

In the simplest model (Table 9-1) looking at how the difference in minutes of the previous matches affects the probability of winning we see that having played a longer previous match than one's opponent decreases the probability of winning; the log odds fall by 0.253 (SE: 0.018) for each additional hour played. We then look for the diminishing effect of the number of prior minutes (Table 9-2) played by looking at the importance of minutes played squared and found no diminishing effects.  

When we control for the difference in ranking points between the two players (Table 9-3), the effect decreases from a 0.253 fall to a 0.158 fall for each additional hour added to the difference previous match length. Controlling for whether or not a player or his opponent was seeded (Table 9-4) further slightly decreases the effect of PMLD.

```{r results = "asis"}
source("~/Documents/masters_paper/models/tennisLog.R")
stargazer(m0, m02, m1, m2, single.row = TRUE, header = FALSE, 
          table.placement = "H", dep.var.labels = "Win probability",
          type = "latex", font.size = "footnotesize",
          covariate.labels = c("Prev. match length diff. (hours)",
                               "Squared match length diff.",
                               "Difference in ranking points", 
                               "Mean ranking points",
                               "Player is seeded",
                               "Opponent is seeded",
                               "Constant"),
          title = "Logistic model for the probability of winning a tennis match")
```

When we look at the effect by best of quantity (Table 10-1), we find that the past match length difference has a stronger effect on winning probability for best of five matches (-0.190, SE: 0.033) than best of three matches (0.124, SE: 0.025). 

We then look at how the surface plays a role (Table 10-2) we find that prior match length has a negative effect on win probability for all surfaces.

```{r results = "asis", cache = FALSE}
source("~/Documents/masters_paper/models/tennisLog.R")
stargazer(m4, m3, single.row = TRUE, header = FALSE, table.placement = "H",
          dep.var.labels = "Win probability", font.size = "footnotesize",
          order = c("delta_rank_pts", "player_seed", "opp_seed"),
          covariate.labels = c("Diff. in ranking points",
                               "Player is seeded",
                               "Opponent is seeded",
                               "Mean rank points",
                               "Best of 3 - PMLD (hours)",
                               "Best of 5 - PMLD (hours)",
                               "Surface: carpet - PMLD (hours)",
                               "Surface: clay - PMLD (hours)",
                               "Surface: grass - PMLD (hours)",
                               "Surface: hard - PMLD (hours)"),
          type = "latex", title = "Effect of previous match length on winning probability by match type")
```
*PMLD = Past match length difference

# Discussion

## Soccer

### Symmetry of predicting home vs. visitor outcomes

Across models, the predictors for home goal or probability of winning have the same order of magnitude and signs as the predictors for visitor goal or probability of winning. They vary in their actual amounts because the baseline probabilities of winning and average number of goals for home and away teams differ.

The one difference we do notice between a home and visitor effect is that of rest on the number of goals scored in a game. Home rest will decrease the number of goals across both teams, while visitor rest will increase it across both teams. This suggest that perhaps the visiting team at a soccer game sets the pace in how aggresively it attacks which depends on its rest level. The home team responds by matching that aggresivity. The home team aims to keep the pace slow (minimize the overall number of goals) and is better equiped to do so when well rested.

### Rest as days or as binary

In all but the bivariate model rest is not a significant predictor regardless of whether it is included as a binary or continuous variable. The magnitude of the binary predictor tends to be about 10 times that of the continuous predictor. To avoid international breaks, we filter out all games where rest exceeds eight days, so the effect of the binary variable being about 10 times that of the continuous variable instead of 6 to 8 times the continuous variable suggest that small variations do not matter as much as large variation. 

When calculating the effect of rest, we only look at Premier League games which happen Friday through Sunday. If a team has five or fewer days of rest, it is highly likely that the team had non-Premier league game during that week. What we are seeing is that teams played during the week are slightly less likely to win during the weekend than if they have not played during the week.

### Importance of game load

In our first attempt at running these models we did not include game load - the number of games a team plays in a season. We found that less rested teams were more likely to win games. This was because better teams are more likely to qualify to play in more games and therefore generally have less rest time between games. Adding season game load as a covariate allows us to control for that. Once we added the covariate we no longer found an effect for rest except in the bivariate model.

## Tennis

### Importance of controlling for ranking points

In the simplest model for the probability of winning a tennis match, the effect of the difference in the length of the player's previous matches is quite large. However, when we add the difference in the players' ranking points and binary variables for whether or not the players' involved are seeded, the effect decreases suggesting some correlation between the predictors.

We find a correlation of 0.023 with a p-value less than $1.02*10^{-5}$ between a player's ranking points and the time needed to win a match. Both of these findings suggest that better players play longer matches. 

One hypothesis for why better players play longer match is that they are more able to put up a fight and last longer against strong opponents. If that is true, we expect the length of matches of better players to increase more with the strength of their opponents than weaker players. 

In the Poisson model below in which we assume that the length of a tennis match is Poisson distributed according to a parameter which is linear in the predictors, we see that the length of seeded players matches increases with the ranking of their opponents more than the length of the matches of unseeded players does: 0.024 hr/ranking point vs 0.005 hr/ranking point. This supports our hypothesis that better players (proxied by seeded players), put up stronger fights against better opponents than unseeded players do.

```{r results = "asis", cache = FALSE}
source("~/Documents/masters_paper/Figures/Make/tennisDiscussion.R")
stargazer(m1, single.row = TRUE, header = FALSE, 
          table.placement = "H", font.size = "footnotesize",
          covariate.labels = c("Unseeded player - Opponent rank points",
                               "Seeded player - Opponent rank points"),
          type = "latex", title = "Effect of opponent's ranking points on match length by player seed")
```

If better players play longer matches we would not see the addition of the difference in ranking points between models 9-1 and 9-3 decrease the effect of previous match length difference; in fact; we would see the opposite. Better players play longer matches, but their ability should make up for some of the tiredness and dwarf the tiredness-PMLD effect in the model where ability is not controlled for (9-1).

When we look at the correlation between the previous match length difference and player' ranking points by round, we find that for all rounds the correlation is negative (Table 12). This means that better players tend to have played shorter previous matches. The correlation is stronger in the earlier rounds were better players face weaker opponents and can beat them quicker than in later rounds where opponents are stronger. One might wonder how we can reconcile better players playing longer matches and better players having played shorter previous matches. For lack of better information we assume that both players play an equal ability opponent in his previous match; on average this is likely true. The better player can beat his opponent quicker. However, better players can win matches against a stronger range of players and as table 11 shows the stronger an opponent, the more time is needed to defeat him. 

```{r results = "asis", cache = FALSE}
library(stargazer)
source("~/Documents/masters_paper/Figures/Make/tennisDiscussion.R")
df = rbindlist(out)
names(df) = c("Round", "Correlation", "P-value")
stargazer(df, summary = FALSE, title = "Correlation between player ranking and length of previous match", type = "latex", header = FALSE)
```

Better players having played shorter previous matches means that PMLD indirectly measures how bad a player is (ability). When we control for the ability of a player the effect of PMLD diminishes. The validity of the effect of previous match length difference is dependent on whether or not the difference in ranking points, mean ranking points, and seeded status adequately control for ability. We verify this by comparing model 9-3 to models subsetting on matches in which players are ranked similarly. 

```{r}
source("~/Documents/masters_paper/models/tennisLog.R")
ggplot(df_out, aes(x = i, y = coef)) + geom_point() + geom_errorbar(aes(ymin = coef - 1.96*se, ymax = coef + 1.96*se)) + 
  theme(plot.title = element_text(size = 10), axis.text.x = element_text(size = 8),
        axis.text.y = element_text(size = 8), axis.title.x = element_text(size = 10),
        axis.title.y = element_text(size = 10)) +
  labs(title = "Effect and 95% CI of PMLD when restricting on the n most similarly ranked matches",
       x = "n", y = "Coefficient")
```

In the above figure, we see that as we limit our model to players who are ranked more and more closely the effect of PMLD decreases slightly. In the 5000 matches with most similarly ranked players, there is no significant effect. It is unclear whether the large error bands there are from the low sample size or the large variation in the games.

### Best of quantity

We find that the effect of previous match length differ slightly but not significantly by best of quantity. The effect appears to be slightly stronger for best of 5 matches.

### Surface 

The effects differ slightly but not significantly by surface. Players often have preferences on surfaces to play on and often cite the physical toll that they take as reasons why.

# Conclusion

## Tennis

Assuming that we do an adequate job of controlling for player ability, we find an effect for the difference in length of the previous match between players on the probability of a player winning. Previous match length difference decreases log odds of winning by 0.151 (0.020) for each additional hour of play. The effect is still significant when broken out by best of quantity and surface, but we cannot say that the effects are significantly different within conditions.

## Soccer

We try a variety of models (Poisson, Bivariate Poisson, and ordered logit) to evaluate the effect of rest days on soccer match outcomes and find no significant effect. We notice that the four control covariates, attacking strength, defensive weakness, and home and visitor game load which have significant effects, have the same magnitude and direction for their effect. This observation confirms existing models in which these are the main predictors. 

## Why we see effects in tennis and not soccer

### Tennis is easier to model than soccer

In our soccer model, we look at how the number of days of rest before a match affects the winning probability and the number of goals scored. We see little variation in the number of days of rest across matches: 45% of games are played within equally rested teams and 76% of games are played between teams with at most one day of rest difference. If the difference is small and there are other factors affecting outcomes we will not be able to see it in a model where most of the differences in rest are small. In the tennis model, we look at how the length of the previous tennis match affects the probability of winning. The average difference in minutes played in the previous match between players is 39 minutes which is 38% percent of the average length of a tennis match. 

Perhaps more important than our predictor, the response variable explains more of why it is easier to measure an effect in tennis than soccer. The number of points in tennis matches is much much higher than in soccer. This means that scoring a point which affects the probability of winning is easier in tennis than in soccer. Tiredness can more easily have a measurable impact on tennis scores than rest does in soccer. 

### Soccer players can be substituted but not tennis players

Another reason for why we see more effects for tennis than soccer is the fact that soccer teams generally have at least 23 players, but only 11 players and three substitutes play in each game. This means that managers can control how tired players are by playing different players in different games. In singles men's tennis, there is only one player; if for a player the length of a match played three days ago affects a match played today we will be able to measure it. This is not the case in soccer where that player may not play the game today.

# Code
# References

Barry Glendenning. "Winter may catch up with english elite as champions league resumes." _The Guardian_, 12 February 2018.

Benjamin Cronin. "Poisson distribution: Predict the score in soccer betting." _pinnacle.com_, 27 April 2017.

Carlos Lago Penas and Andrzej Soroka. "The effect of a succession of matches on the physical performance of elite football players during the world cup brazil 2014". _Inter-national Journal of Performance Analysis in Sport_, 16(2):434â441, 2016.

Carlos Lago Penas. "The effect of a succession of matches on the activity profiles of professional soccer players." _European Congress of Sports Medicine_, 3rd Central European Congress of Physical Medicine and Rehabilitation, 2011.

Dimitris Karlis and Ioannis Ntzoufras (2007). "bivpois: Bivariate Poisson Models Using The EM Algorithm." _R package version 0.50-3.1_. http://www.stat-athens.aueb.gr/~jbn/papers/paper14.htm

Dries R. Goossens, Jurgen Kempeneers, Ruud H. Koning and Frits C.R. Spieksma. "Winning in straight sets helps in Grand Slam tennis." _International Journal of Performance Analysis in Sport_, 2015(15):1007-1021.

GMAdevs. November 2017. Association of Tennis Professionals Matches, Version 2. _Kaggle_, https://www.kaggle.com/gmadevs/atp-matches-dataset.

Hlavac, Marek (2018). "stargazer: Well-Formatted Regression and Summary Statistics Tables." _R package version 5.2.1_. https://CRAN.R-project.org/package=stargazer

H. Wickham. "ggplot2: Elegant Graphics for Data Analysis". Springer-Verlag New York, 2009.

James Curley (2016). engsoccerdata: English and European Soccer Results 1871-2016. R package version 0.1.5. https://CRAN.R-project.org/package=engsoccerdata
  
Jeff Cooper. "Seeding: Key to Competitive Tourneys". _ThoughtCo_, 28 November 2017.

Karlis Dimitris and Ioannis Ntzoufras. "Analysis of sports data using bivariate poisson models." _Journal of the Royal Statistical Society: Series D (The Statistician)_ ,52(3):381â393, 2003

Klaassen, Franc J. G. M. and Jan R. Magnus. âForecasting the winner of a tennis match.â _European Journal of Operational Research_, 148(2003):257-267.

Maher M. J. "Modeling association football scores." _Statistica Neerlandica_, 36(3):109â118, 1982.

Mark Critchley. "Manchester United manager Jose Mourinho claims English clubs are at a disadvantage in the Champions League". _Independent_, 11 September 2017.

Michal Sipko. "Machine Learning for the Prediction of Professional Tennis Matches." _Imperial College London_, 15 June 2015

Tiago Julio Costa Pereira, FÃ¡bio Yuzo Nakamura, Mayra Tardelli de Jesus, Claudio LuÃ­s Roveri Vieira, Milton Shoiti Misuta, Ricardo Machado Leite de Barros & Felipe Arruda Moura (2017) "Analysis of the distances covered and technical actions performed by professional tennis players during official matches." _Journal of Sports Sciences_, 35(4):361-368.

Wikipedia contributors, "Premier League", "FA Cup", "EFL Cup", "UEFA Champions League", "UEFA Europa League". _Wikipedia_, The Free Encyclopedia


